<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Landmark AR (Fix Loading)</title>
    <!-- æ”¹ç”¨å›½å†…å¯è®¿é—®çš„ç¨³å®šCDNï¼Œé¿å…åŠ è½½è¶…æ—¶ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/0.150.1/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/ar-nft/2.4.0/threex-artoolkitcore.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/ar-nft/2.4.0/threex-artoolkitcontroller.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/ar-nft/2.4.0/threex-artoolkitsource.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: Arial, sans-serif; color: #333; }
        #error { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); font-family: Arial, sans-serif; color: #e74c3c; font-size: 14px; display: none; }
    </style>
</head>
<body>
    <div id="loading">Loading AR Scene...<br>Please allow camera permission</div>
    <div id="error" id="errorMsg"></div> <!-- é”™è¯¯æç¤ºï¼Œå¡ä½æ—¶æ˜¾ç¤ºåŸå›  -->

    <script>
        // å…¨å±€é”™è¯¯ç›‘å¬ï¼ˆå¡ä½æ—¶æ˜¾ç¤ºåŸå› ï¼‰
        window.addEventListener('error', function(e) {
            document.getElementById('loading').style.color = '#e74c3c';
            document.getElementById('errorMsg').innerText = 'Error: ' + e.message;
            document.getElementById('error').style.display = 'block';
        });

        // Three.js Core: ç®€åŒ–åˆå§‹åŒ–
        const scene = new THREE.Scene();  
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ğŸ”¥ ä¿®å¤1ï¼šä¼˜åŒ–ARè§†é¢‘æºåˆå§‹åŒ–ï¼ˆå…¼å®¹æ›´å¤šè®¾å¤‡ï¼‰
        let arSource, arController;
        try {
            arSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
                sourceWidth: window.innerWidth,
                sourceHeight: window.innerHeight,
                // å¢åŠ æ‘„åƒå¤´é€‚é…å‚æ•°
                sourceWidthMin: 640,
                sourceHeightMin: 480
            });
        } catch (e) {
            document.getElementById('errorMsg').innerText = 'Camera init failed: ' + e.message;
            document.getElementById('error').style.display = 'block';
        }

        // çª—å£é€‚é…ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
        window.addEventListener('resize', function() {
            if (arSource) arSource.onResize();
            if (arSource) arSource.copySizeTo(renderer.domElement);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        });

        // ğŸ”¥ ä¿®å¤2ï¼šå¼‚æ­¥åˆå§‹åŒ–ï¼Œé¿å…é˜»å¡
        if (arSource) {
            arSource.init(function(err) {
                if (err) {
                    document.getElementById('errorMsg').innerText = 'AR source init failed: ' + err.message;
                    document.getElementById('error').style.display = 'block';
                    return;
                }
                arSource.copySizeTo(renderer.domElement);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                // æœ¬åœ°æ ‡è®°é…ç½®ï¼ˆç¡®ä¿è·¯å¾„æ­£ç¡®ï¼‰
                try {
                    arController = new THREEx.ArToolkitController({
                        camera: camera,
                        renderer: renderer,
                        markerPatternUrl: './marker.patt', // é‡ç‚¹ï¼šæœ¬åœ°è·¯å¾„
                        detectionMode: 'mono', // ç®€åŒ–è¯†åˆ«æ¨¡å¼ï¼Œæé«˜å…¼å®¹æ€§
                        threshold: 150, // è°ƒæ•´é˜ˆå€¼ï¼Œé€‚é…æ™®é€šæ‰“å°æœº
                        maxDetectionRate: 30, // é™ä½æ£€æµ‹é€Ÿç‡ï¼Œå‡å°‘å¡é¡¿
                    });

                    // åˆå§‹åŒ–æˆåŠŸ/å¤±è´¥ç›‘å¬
                    arController.addEventListener('ready', function() {
                        document.getElementById('loading').style.display = 'none'; // åŠ è½½å®Œæˆï¼Œéšè—æç¤º
                    });

                    arController.addEventListener('error', function(err) {
                        document.getElementById('errorMsg').innerText = 'AR controller error: ' + err.message;
                        document.getElementById('error').style.display = 'block';
                    });

                    arController.start();
                    scene.add(arController.object3d);
                } catch (e) {
                    document.getElementById('errorMsg').innerText = 'AR controller init failed: ' + e.message;
                    document.getElementById('error').style.display = 'block';
                }
            });
        }

        // å­¦ç”Ÿä¿®æ”¹éƒ¨åˆ†ï¼šé¦™æ¸¯åœ°æ ‡3Dæ¨¡å‹ï¼ˆç®€åŒ–ä»£ç ï¼Œé¿å…é˜»å¡ï¼‰
        const mainBuilding = new THREE.Mesh(
            new THREE.BoxGeometry(2, 1.5, 1),
            new THREE.MeshBasicMaterial({ color: 0xe74c3c })
        );
        mainBuilding.position.y = 0.75;

        const topPart = new THREE.Mesh(
            new THREE.BoxGeometry(2.2, 0.3, 1.2),
            new THREE.MeshBasicMaterial({ color: 0x3498db })
        );
        topPart.position.y = 2.25;

        const hkcecModel = new THREE.Group();
        hkcecModel.add(mainBuilding);
        hkcecModel.add(topPart);
        if (arController) arController.object3d.add(hkcecModel);

        // ç®€åŒ–æ¸²æŸ“é€»è¾‘ï¼ˆé¿å…æ­»å¾ªç¯é˜»å¡ï¼‰
        function animate() {
            requestAnimationFrame(animate);
            if (hkcecModel) hkcecModel.rotation.y += 0.005;
            if (arController && arController.update) {
                try {
                    arController.update(arSource ? arSource.domElement : null);
                } catch (e) {}
            }
            renderer.render(scene, camera);
        }
        animate();

        console.log('AR Project - Debug Info:');
        console.log('File path check: Ensure marker.patt is in the same folder as HTML');
        console.log('Camera permission: Check browser settings');
    </script>
</body>
</html>